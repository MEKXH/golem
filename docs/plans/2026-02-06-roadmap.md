# Golem 渐进式开发路线图

> 基于 2026-02-06 对代码库的全面审计，结合原始设计文档 (`2026-02-04-golem-design.md`) 中的愿景制定。
> 每个阶段可独立交付、独立合并，后续阶段建立在前一阶段之上。

---

## 现状总结

### 已实现

- 基础 Agent Loop（LLM 调用 + 工具循环）
- 消息总线（InboundMessage / OutboundMessage）
- 4 个内置工具：`read_file`、`write_file`、`list_dir`、`exec`
- Telegram 渠道（长轮询 + HTML 渲染 + ACL）
- TUI 交互（Bubble Tea + Glamour Markdown 渲染 + `<think>` 块解析）
- 5 个 Provider 已接线：OpenRouter、Claude、OpenAI、DeepSeek、Ollama
- 配置系统（Viper + JSON + 环境变量覆盖）
- 会话持久化（JSONL）
- 三种工作区模式（default / cwd / path）
- Release CI（tag 触发构建 Linux + Windows 二进制）

### 关键缺口

| 类别 | 问题 |
|------|------|
| 安全 | 文件工具无工作区边界检查，`restrict_to_workspace` 配置存在但从未执行 |
| 安全 | 危险命令黑名单可被轻易绕过（`rm -r -f /`、`sudo rm -rf /` 等） |
| CI | 无测试流水线——PR/push 无自动化测试 |
| 测试 | `write_file`、`list_dir` 无测试；`processMessage` 多轮工具循环未测试；会话持久化未测试 |
| 功能 | 设计文档中 5 个工具未实现：`edit_file`、`web_search`、`web_fetch`、`message`、`spawn` |
| 功能 | 4 个配置了的 Provider 未接线：Gemini、Ark、Qianfan、Qwen |
| 功能 | Gateway HTTP 服务不存在（config 和 CLI flag 已声明） |
| 功能 | Memory 系统（日记、长期记忆）未实现 |
| 功能 | 缺少 `golem version` 子命令 |
| 代码 | `splitThink` 函数在两个包中重复；正则表达式每次调用重编译；`shell.go` 双重创建 cmd |
| 代码 | `media` 参数被接收但被完全忽略；`port` CLI flag 声明但未使用 |

---

## Phase 1: 安全加固与代码质量 ⚡ 优先级最高

> **目标**：修复所有安全隐患，清理代码异味，补齐关键测试。
> **预估范围**：~10 个文件修改

### 1.1 实施工作区沙箱

**文件**：`internal/tools/filesystem.go`、`internal/tools/shell.go`

- 所有文件工具（`read_file`、`write_file`、`list_dir`）添加路径规范化检查
  - `filepath.Abs()` → `filepath.Clean()` → 检查是否在 workspace 路径内
  - 拦截 `..` 路径穿越
- `exec` 工具真正实施 `restrict_to_workspace`
  - 当 `restrictToWorkspace=true` 时，拒绝包含绝对路径（workspace 外）的命令
  - 强制 `WorkingDir` 在 workspace 内
- 修复 `shell.go` 中的双重 cmd 构造问题（lines 56-76）
- 增强危险命令黑名单
  - 使用正则而非子串匹配
  - 覆盖 `sudo` 前缀、参数分离（`rm -r -f`）等变种

**测试**：
- `filesystem_test.go`：测试路径穿越被拒绝、workspace 内读写正常
- `shell_test.go`：测试各种危险命令变种被拦截、`restrict_to_workspace` 生效

### 1.2 配置安全与验证

**文件**：`internal/config/config.go`

- 配置文件权限改为 `0600`（仅用户可读写）
- 添加配置校验函数 `Validate() error`
  - 检查 `max_tool_iterations` 正整数
  - 检查 `temperature` 在合理范围 [0, 2]
  - 检查 workspace_mode 合法值
- 修复 `os.UserHomeDir()` 错误被静默忽略的问题

### 1.3 代码去重与清理

**文件**：多处

- 提取 `splitThink` 到 `internal/render/think.go`（或类似共享位置），消除 `chat.go` 和 `telegram.go` 间的重复
- 将 `markdownToHTML` 中的 `regexp.MustCompile` 提升为包级别 `var`
- 移除 `chat.go` 中未使用的 `toolStyle` 字段
- 移除 `run.go` 中声明但未使用的 `port` flag（或真正使用它）
- 修复 `chat.go` 中过期的注释（"We avoid rendering markdown for thinking"）

### 1.4 补齐关键测试

**文件**：新增/修改测试文件

- `internal/tools/filesystem_test.go`：`write_file` 和 `list_dir` 的单元测试
- `internal/session/manager_test.go`：`Save()` 和 `loadFromDisk()` 持久化往返测试
- `internal/agent/loop_test.go`：mock 多轮工具调用场景测试
- `internal/tools/shell_test.go`：危险命令各变种测试

---

## Phase 2: CI/CD 与工程基础

> **目标**：建立自动化测试流水线，引入 `golem version` 命令。
> **预估范围**：2-3 个新文件

### 2.1 CI 测试流水线

**文件**：`.github/workflows/ci.yml`（新建）

```yaml
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.25"
      - run: go test ./... -v -race
      - run: go vet ./...
```

- 添加 `-race` 竞态检测
- 添加 `go vet` 静态分析
- 后续可扩展 `golangci-lint`

### 2.2 Version 子命令

**文件**：`cmd/golem/commands/version.go`（新建）、`cmd/golem/commands/root.go`

- 新增 `golem version` 子命令，输出版本号和构建信息
- 在 `root.go` 中注册

---

## Phase 3: 工具系统扩展

> **目标**：实现设计文档中缺失的高价值工具。
> **依赖**：Phase 1（沙箱机制）
> **预估范围**：每个工具 1 个文件 + 1 个测试文件

### 3.1 edit_file 工具

**文件**：`internal/tools/filesystem.go`（扩展）

- 参数：`path`、`old_text`、`new_text`
- 实现精确替换（非正则），类似 sed 但更安全
- 复用 Phase 1 的沙箱路径检查
- 单元测试覆盖：正常替换、多次匹配、不匹配返回错误

### 3.2 web_search 工具

**文件**：`internal/tools/web.go`（新建）

- 使用 Brave Search API（配置已存在于 `WebSearchConfig`）
- 参数：`query`、`max_results`（可选）
- 返回搜索结果标题、URL、摘要
- 当 API Key 未配置时返回友好错误
- 注册到 `RegisterDefaultTools`（仅当配置有 API Key 时）

### 3.3 web_fetch 工具

**文件**：`internal/tools/web.go`（扩展）

- 参数：`url`
- 获取网页内容，HTML 转纯文本/Markdown
- 添加超时控制和内容长度限制
- 考虑使用 `go-readability` 或简单的 HTML-to-text 转换

### 3.4 工具注册改进

**文件**：`internal/agent/loop.go`

- `RegisterDefaultTools` 改为条件注册——仅在相关配置存在时注册 web 工具
- 添加日志输出已注册的工具列表

---

## Phase 4: Provider 补全与模型管理

> **目标**：接线所有配置中声明的 Provider，清理未使用的配置字段。
> **预估范围**：1-2 个文件修改

### 4.1 补全 Provider 工厂

**文件**：`internal/provider/provider.go`

按设计文档的优先级顺序补全：
根据eino和eino-ext包中的实现，补全以下 Provider：

| Provider | BaseURL | 说明 |
|----------|---------|------|
| Gemini | `https://generativelanguage.googleapis.com/v1beta/openai` | Google Gemini OpenAI 兼容接口 |
| Ark | 用户配置 `base_url` | 火山引擎，需 `base_url` |
| Qianfan | 用户配置 `base_url` | 百度千帆，需 `base_url` |
| Qwen | `https://dashscope.aliyuncs.com/compatible-mode/v1` | 阿里通义千问 OpenAI 兼容接口 |

- 优先使用eino-ext中的适配实现，如果不清楚请使用context-7 mcp查看eino和eino-ext文档
- 在 `NewChatModel` 的 switch 中按设计文档优先级排列
- 移除或标记 `ProviderConfig.SecretKey`（当前无人使用）

### 4.2 Provider 单元测试

**文件**：`internal/provider/provider_test.go`

- 测试每个 Provider 的配置检测逻辑（无需真实 API 调用）
- 测试优先级顺序：当多个 Provider 同时配置时，选择优先级最高的

---

## Phase 5: Memory 系统

> **目标**：实现设计文档中的记忆系统——长期记忆和日记。
> **依赖**：Phase 1（工作区路径正确性）
> **预估范围**：2-3 个新文件

### 5.1 Memory 管理器

**文件**：`internal/memory/memory.go`（新建）

- `MEMORY.md`：长期记忆文件，Agent 可通过工具读写
- 日记系统：`memory/YYYY-MM-DD.md`
  - Agent 可追加当日日记
  - ContextBuilder 自动加载最近 3 天日记到系统提示词
- 提供 `ReadMemory()`、`WriteMemory()`、`AppendDiary()` 函数

### 5.2 Memory 工具

**文件**：`internal/tools/memory.go`（新建）

- `read_memory` 工具：读取 MEMORY.md
- `write_memory` 工具：更新 MEMORY.md
- `append_diary` 工具：追加当日日记
- 注册到 `RegisterDefaultTools`

### 5.3 Context Builder 集成

**文件**：`internal/agent/context.go`

- `BuildSystemPrompt` 中加载 MEMORY.md 内容
- 加载最近 3 天日记内容
- 修复当前 `media` 参数被忽略的问题（至少作为文本路径提示加入消息）

---

## Phase 6: 日志与可观测性

> **目标**：提供可配置的日志级别和结构化输出。
> **预估范围**：3-4 个文件修改

### 6.1 可配置日志

**文件**：`internal/config/config.go`、`cmd/golem/commands/root.go`

- 配置中添加 `log` 段：
  ```json
  {
    "log": {
      "level": "info",
      "file": ""
    }
  }
  ```
- 全局 flag `--log-level` 覆盖配置
- `chat` 命令在 TUI 模式下日志写文件（如配置了 `log.file`），而非直接丢弃

### 6.2 请求追踪

**文件**：`internal/agent/loop.go`、`internal/bus/events.go`

- 为 `InboundMessage` 添加 `RequestID` 字段（UUID）
- 在 agent loop 的日志中携带 `request_id`，实现消息全链路追踪
- 为工具执行添加耗时记录

---

## Phase 7: TUI 增强

> **目标**：改善终端交互体验。
> **预估范围**：1-2 个文件修改

### 7.1 多行输入支持

**文件**：`cmd/golem/commands/chat.go`

- 当前 Enter 直接发送，无法输入多行
- 改为 Shift+Enter 或 Alt+Enter 插入换行，Enter 发送
- 或采用类似 `---` 分隔符方案

### 7.2 会话管理命令

**文件**：`cmd/golem/commands/chat.go`

- TUI 内支持 `/clear` 命令清空当前会话
- TUI 内支持 `/history` 命令查看历史
- TUI 内支持 `/export` 命令导出对话为 Markdown

### 7.3 工具执行确认

**文件**：`cmd/golem/commands/chat.go`

- 对 `exec`、`write_file` 等有副作用的工具，在 TUI 中显示确认提示
- 添加配置项 `tools.exec.confirm: true` 控制是否需要确认

---

## Phase 8: Gateway HTTP 服务

> **目标**：实现设计中的 Gateway，提供 HTTP API。
> **依赖**：Phase 2（version 命令作为 API 端点的基础）
> **预估范围**：2-3 个新文件

### 8.1 基础 HTTP 服务器

**文件**：`internal/gateway/server.go`（新建）

- 使用标准库 `net/http` 或轻量路由库
- 绑定 `GatewayConfig` 中的 `host` 和 `port`
- 端点：
  - `GET /health`：健康检查
  - `GET /version`：版本信息
  - `POST /chat`：发送消息并获取响应
- 集成到 `run` 命令中（使用已声明的 `--port` flag）

### 8.2 API 认证

- 简单的 Bearer Token 认证
- Token 配置在 `gateway` 段中：
  ```json
  {
    "gateway": {
      "host": "0.0.0.0",
      "port": 18790,
      "token": "your-api-token"
    }
  }
  ```

---

## Phase 9: 渠道扩展

> **目标**：验证渠道抽象的可扩展性，新增至少一个渠道。
> **依赖**：Phase 8（Gateway 作为消息入口）
> **预估范围**：1-2 个新文件

### 9.1 Telegram 渠道改进

**文件**：`internal/channel/telegram/telegram.go`

- 长消息分片发送（Telegram 4096 字符限制）
- 消息并发限制（避免无限 goroutine 创建）
- 添加消息发送重试逻辑

### 9.2 CLI 渠道标准化

**文件**：`internal/channel/cli/cli.go`（新建）

- 将当前 `ProcessDirect` 重构为标准 Channel 实现
- 使 CLI 也走消息总线流程，统一架构
- `chat` 命令中通过 Channel Manager 使用 CLI 渠道

### 9.3 Discord 渠道（可选）

**文件**：`internal/channel/discord/discord.go`（新建）

- 配置段：`channels.discord`
- 使用 `discordgo` 库
- 复用 Channel 接口和 BaseChannel

---

## Phase 10: 高级 Agent 功能

> **目标**：实现设计文档中的子 Agent 和 Message 工具。
> **依赖**：Phase 3（工具系统完善）、Phase 5（Memory 系统）
> **预估范围**：2-3 个新文件

### 10.1 Message 工具

**文件**：`internal/tools/message.go`（新建）

- 允许 Agent 主动向渠道发送消息
- 参数：`channel`、`chat_id`、`content`
- 通过消息总线的 Outbound 队列发送

### 10.2 Sub-agent 系统

**文件**：`internal/agent/subagent.go`（新建）

- `spawn` 工具创建子 Agent
- 子 Agent 有独立的工具集和系统提示
- 父 Agent 可等待子 Agent 结果
- 初始实现：同步执行，后续可扩展为并行

---

## 实施建议

### 优先级排序

```
Phase 1 (安全) ──► Phase 2 (CI) ──► Phase 3 (工具) ──► Phase 4 (Provider)
                                          │
                                          ▼
                                    Phase 5 (Memory) ──► Phase 10 (高级 Agent)
                                          │
                                    Phase 6 (日志)
                                          │
                                    Phase 7 (TUI)
                                          │
                                    Phase 8 (Gateway) ──► Phase 9 (渠道)
```

### 每个 Phase 的交付标准

1. 所有新代码有对应单元测试
2. `go test ./... -race` 全部通过
3. `go vet ./...` 无警告
4. 功能在对应使用场景下手动验证通过
5. 更新 CLAUDE.md 中的架构描述（如有结构性变化）

### 分支策略

- 每个 Phase 开一个 feature 分支：`feature/phase-N-description`
- Phase 内的子任务可以是单独的 commit
- 合并前确保 CI 通过
